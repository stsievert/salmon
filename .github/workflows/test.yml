name: Test Salmon server

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Setup Python 3.7
      uses: actions/setup-python@v2
      with:
        python-version: 3.7
    - name: Add conda to system path
      run: |
        # $CONDA is an environment variable pointing to the root of the miniconda directory
        echo $CONDA/bin >> $GITHUB_PATH
    - name: Debug info
      run: |
          echo "Running `pwd`..."
          pwd
          echo "Running `echo $USER`..."
          echo $USER
          echo "Running mkdir..."
          mkdir ./salmon/dask-worker-space
          echo "Running `ls`..."
          ls
          echo "Running chown..."
          sudo chown -R $USER:$USER /home/github/actions-runner/_work/salmon
    - name: Prepare for docker build...
      run: |
          chmod +x launch.sh
          # chown -R -H -L $USER:$USER .
          sudo chown -R -H -L $USER:$USER .
          sudo chown -R -H -L $USER:$USER salmon docs tests
    - name: Install dependencies
      run: |
        conda env update --file salmon.yml --name base
    - name: Install Salmon
      run: pip install -e .
    - name: Build Salmon server w/ Docker
      run: |
          export SALMON_NO_AUTH=1
          docker-compose up &
          until curl 127.0.0.1:8421 > /dev/null 2>&1; do :; done  # wait for container to start
          docker ps
    - name: Run tests
      run: pytest
